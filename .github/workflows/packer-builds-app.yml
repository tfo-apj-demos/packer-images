name: Build VMware App Images

on:
  workflow_dispatch:
    inputs:
      singleBuild:
        type: choice
        description: image override
        required: false
        options: 
          - ubuntu_2204_vault
          - ubuntu_2204_postgres
          - ubuntu_2204_docker
          - ubuntu_2204_docker
          - ubuntu_2204_haproxy
  schedule:
   - cron:  '0 11 * * SUN' # UTC TIME

env:
  DEFAULT_IMAGES: '[ubuntu_2204_vault, ubuntu_2204_postgres, ubuntu_2204_docker, ubuntu_2204_haproxy]'
  HCP_CLIENT_ID: ${{ secrets.HCP_CLIENT_ID }}
  HCP_CLIENT_SECRET: ${{ secrets.HCP_CLIENT_SECRET }}
  HCP_PROJECT_ID: ${{ secrets.HCP_PROJECT_ID }}
  VCENTER_USERNAME: ${{ secrets.VCENTER_USERNAME }}
  VCENTER_PASSWORD: ${{ secrets.VCENTER_PASSWORD }}
  VCENTER_SERVER: ${{ secrets.VCENTER_SERVER }}
    
jobs:
  selectimages:
    runs-on: "ubuntu-latest"
    steps:
      - name: get-images
        id: get-images
        run: |
          echo "images=$DEFAULT_IMAGES"
          echo "images=$DEFAULT_IMAGES" >> "$GITHUB_OUTPUT"
      - name: get-images-override
        id: get-images-override
        if: ${{inputs.singleBuild}} != ''
        run: |
          echo "images=${{inputs.singleBuild}}"
          echo "images=${{inputs.singleBuild}}" >> "$GITHUB_OUTPUT"
  build:
    runs-on: [self-hosted, gcve]
    needs: [selectimages]
    strategy:
      matrix:
        image_type: [ubuntu_2204_vault, ubuntu_2204_postgres, ubuntu_2204_docker, ubuntu_2204_haproxy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run Makefile
        run: make ${{ matrix.image_type }}
      
